# CONTRIBUTE

> 导出自语雀文档，不建议直接修改该文件。

## Git版本控制
### 分支规范
以下分支为位于[中心仓库](https://github.com/SafewindClub/safe-wind-backed)的受控保护分支，**任何人** 不能直接往上推送可能被回退的提交。

+ `main`：发布版，关联到自动部署流水线和版本号更替流水线。
+ `dev`：开发中心分支，所有特性和主题分支须先行合并到dev。

### 提交备注
Git提交时会需要附加一段备注表明这个提交在干什么。我们应尽量遵从下面的一般性规范：

+ 提交备注的第一行为提交 **标题** ：简述你的操作。
+ 标题后**空一行**。之后是标题的详细描述，你可以使用Markdown格式化你的描述（尤其是列表）。这样做虽然在大多数时候不会被你所使用的工具渲染，但是大多数时候意外地具有可读性。

![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747984592769-61fdd11d-7608-48eb-9499-4f7973648178.png)

虽然不是强制性规范，但是推荐在提交标题中以一个 `[相关的模块名]`开头。如果模块名太长，也没必要，标题的第一要务是保持简短。

![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747984704726-5da6e569-cafb-445a-b8cc-61218f6c0cd0.png)

### Git鼓励的提交风格
+ 分支成本小，鼓励多分支
+ 鼓励小而描述清晰的提交。

> 上述风格来源于早期Git的应用背景：大量不同背景，没有实时沟通服务器的贡献者们协作。
>

### 工作流指导-提交鼓励多分支

采取典型的 Github 工作流：

1. 中心仓库被所有贡献者共享，只有项目的管理员能够直接修改中心仓库内容。
2. 想要修改中心仓库的内容，应该使用 `fork`功能：  
   ![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747982577191-357e3ce4-9b50-4c44-9cf3-df86a591708e.png)  
   以获取一个所有权在自己的代码库副本。想进行的所有修改应该在自己的代码库副本上进行，然后通过拉取请求，请求项目管理员拉取你的修改并合并到中心仓库。具体操作如下：
3. Fork仓库：![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747982748163-890256d2-3178-4c7e-9149-ea22522536ea.png)  
   注意取消勾选 `main branch only`，我们的仓库中 `dev`分支也是共有分支，请一并追踪。
4. Fork仓库后，你将会获得整个仓库的副本：![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747982840054-6a07271b-b331-445a-a3c4-4144fbf5d8d1.png)  
   该副本的分支会（半）自动地追踪中心仓库中的分支。
5. 为了修改仓库中的内容，你需要将其拉到本地，或者如果你已经拉取过中心仓库，也可以仅添加一个新的远程追踪仓库到你的本地仓库。（这里不再演示如何操作Git客户端）
6.  即使在你的本地仓库，我们也不建议你直接修改 `dev` `main`共享分支，他们应该仅用于与对应的远程分支同步。所以为了进行修改，你应该选择一个合适的基分支（可能是 `dev` 也可能是其他 _主题分支_ 。）  
    ，并新建一个分支，进行修改。这里已添加一个 `CONTRIBUTE.md` 文件为例，该名字的文件在开源项目中指导新加入的贡献者遵从项目特有的开发规范，或引导他们熟悉项目。关于提交的备注的规范请参考下文。![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747983600563-2c675044-4f85-43d7-8e03-796ab17f695e.png)
7. 接下来把这个分支推送到 **你的Fork仓库** (这里我给它取名为 `own`)。  
   ![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747983675463-7ebad527-c67c-478b-a66d-54278ba6f948.png)
8. 这样在你的仓库页，你就能看到Github收到了提交，并提醒你提交PR（Pull Request）到上游。  
   ![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747983751403-b0409c90-073e-4060-ae17-c6242d6acdd8.png)
9. 编辑好PR的标题和内容。选择好合并到的**仓库和分支**提交即可。如果你的PR并没有准备好，但你需要把它发出来与其他贡献者共同，可以提交一个 `Draft Pull Request`。  
   ![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747983944242-15e519e0-9bfd-41b5-8412-da5bca477989.png)
10. 接下来，只需要与管理员沟通，接受 **代码复核 **。你的代码可能会因为不符合某些规范被管理员拒绝，这时你需要更新你的代码，只要在你本地的分支上编辑好并推送到你的远程仓库上，这里就会自动更新。
11. 你的代码最终可能会被合并到中心仓库，也可能不会。不管怎样，你的fork仓库中与中心当库对应的分支，不会自动的与中心仓库保持一致，如果需要获取上游的更新，你需要手动点击同步：  
    ![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747984231623-ca6b0f91-36e2-46bd-b8c0-c4102a260c0f.png)

> 按照Github新的（也不算新了，好像）安全策略。你可能需要为你的Github账号配置一个SSH密钥才可正常提交。

### 工作流指导-代码复审
这里使用Github进行代码复审时可能需要的操作。

#### 签出拉取请求
一个多人参与的项目可能有大量PR需要复审（Review），Github提供了基础的交流通道，代码浏览功能，以及自动代码检查（的钩子）。![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747985439593-8f367103-86c2-4467-a60d-87afb20e8538.png)

更一般的情况是，复审者需要将提交者的代码拉至本地。直接通过Git签出Github的Pull request需要了解关于引用规范相关的机制。可以直接使用Github的CLI程序 `gh`做到这件事:![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747985848784-0003f385-a099-4f2b-8219-4c22f88b8c83.png)

或者如果你使用JetBrains系的IDE，或者其他具有Github扩展的IDE，他们可能集成了这项功能。

![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747985896009-1a7d9110-fb13-4460-ba7b-60fb0a0d0bbe.png)

#### 合并和合并冲突
Git对分支合并使用三方合并，意思是Git会对要合并的两个分支参考三个提交：两个分支的最后一个公共提交，和两个分支各自的最后一个提交。通过他们的公共提交和最新的提交进行对比就能知道相比另一个分支，这个分支修改了哪些内容，以及他们有没有修改相同的内容（有冲突）。

##### 合并风格
对于与要合并到分支没有冲突的PR，可以在Github一键合并。![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747986717285-262ab331-84fc-42a4-befa-4ae7ba0e4537.png)

这个下拉菜单表示的三个选项是合并风格：

+ merge：产生一个合并提交，它的父提交是合并的两个分支
+ squash merge：产生一个合并提交，但是父分支只有基分支
+ rebase：将待合并分支上的修改“重演”到基分支上，删除一个线性流程

对于合并风格的选择一直争论不休，唯一的共识是：一个项目应该保持一种合并风格。

合并后一般主题分支不会再被使用，删除它：

![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747986972000-7c08a3da-dfc2-4c5c-9349-db80e5543099.png)

##### 合并冲突
而对于有冲突的提交，需要手动处理冲突。对于现版本的Github，提供了基础的合并处理界面（Resolve conflicts）：

![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747987081903-efbc33b0-b00a-4a3d-8e70-de64479c09c3.png)

![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747987139976-3b8a1215-1a38-414d-97df-3c6869bb3c93.png)

```plain
<<<<<<< [branch-name]
来自待合并分支（Ours）的代码
=======
带来基分支的代码（Theirs）
>>>>>>> [base-branch-name]
```

上面这个都是箭头的格式，是Git的标记冲突的方式，它提供了冲突的位置和分支两侧不同处理。删除它并提供合适代码，然后想git标记该冲突已解决基本的冲突合并操作。

直接在Github上操作可能缺少支持，Github提供了在本地进行合并的引导详见对应的“View commandline instructions”页面。它的意思是：你需要将你需要**合并公共分支的代码合并到你的PR分支**，然后提交一个合并后的提交到PR分支，这样PR就能直接合并了。**推荐这个操作由贡献者完成**。

#### Pull request管理
![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747987915160-f0b05d23-385e-48a2-a144-c4d73132ae28.png)

上图是PR的元属性配置。用于管理者分类PR。

+ Assigners分配该PR的复审者。
+ Labels是分类标签，可以自定义。
+ Project是Github提供的项目排期工具，PR可以附加到一个或多个Project上，并通过Project分配进程管理。
+ Milestone是Github提供的另一种项目进度标志，可以将多项PR，Issue标记到一个Milestone作为项目的一个打进度的标志。
+ Development：项目关联到的Issue，这个PR合并后会自动关闭相关的Issue。

### 工作流指导-问题和进度追踪（略）
Issue是Github项目中作为讨论版的存在（以前是，现在由Discussions了，一些没有主题，或者重复的讨论挪到Discussions了）。

对于Bug报告，和重要特性可以现发布到Issue讨论。![](https://cdn.nlark.com/yuque/0/2025/png/1787894/1747989222145-49e32f19-e1bc-4804-a40e-ee041bf8c368.png)

## 开发环境
外部依赖设施（数据库服务器等）的定义（比如数据表定义）作为基础设施层的一部分进行版本控制。保证我们能够从任何一个提交的所包含的信息中构造出基础设施的必要部分。

对于数据库和其他设施不编码到版本库，作为外部配置项（比如环境变量，JVM选项etc。）提供。

共用开发环境、生产环境作为外部资料提供，仅供组内开发人员使用。

### 本地开发环境配置
通过Docker和版本库内的脚本构建，作为最基本的设施提供（留点去中心化的念想，万一项目凉了，但是有人看呢）。

### 共用开发环境配置
通过外部环境变量列表提供，属于受限的访问内容。

### 生产环境
同共用开发环境，仅仅运维部分可见。  
管理者可见。

### CI/CD
暂时用Github Action提供，通过Github Secret配置到共用开发环境进行自动单元测试（不要忘了写 **单元测试**）。

合并到main分配自动触发部署流水线。

## 部署与运维规范